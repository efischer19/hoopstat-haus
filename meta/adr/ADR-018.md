---
title: "ADR-018: Infrastructure as Code with AWS CDK and Terraform"
status: "Proposed"
date: "2025-01-27"
tags:
  - "infrastructure"
  - "iac"
  - "aws"
  - "deployment"
---

## Context

* **Problem:** The Hoopstat Haus project needs a systematic approach to manage AWS infrastructure for data storage, container orchestration, and application deployment. Manual infrastructure management is error-prone, not repeatable, and lacks version control.
* **Constraints:** Must integrate well with AWS services, support multiple environments (development, staging, production), enable disaster recovery, provide cost management visibility, and maintain security best practices.

## Decision

We will use **AWS CDK (Cloud Development Kit) for application infrastructure** and **Terraform for foundational infrastructure**, creating a hybrid approach that leverages the strengths of both tools.

## Considered Options

1. **AWS CDK + Terraform Hybrid (The Chosen One):** Use Terraform for foundational resources and CDK for application stacks.
   * *Pros:* CDK excellent for application-aware infrastructure with Python familiarity, Terraform excellent for foundational infrastructure and state management, leverages strengths of both tools, strong AWS integration
   * *Cons:* Two tools to maintain, requires knowledge of both, potential state management complexity

2. **AWS CDK Only:** Use CDK for all infrastructure management.
   * *Pros:* Single tool, Python familiarity for development team, excellent AWS service support, type safety, powerful abstractions
   * *Cons:* AWS-specific, less mature for complex state management, smaller community compared to Terraform

3. **Terraform Only:** Use Terraform for all infrastructure management.
   * *Pros:* Single tool, mature ecosystem, excellent state management, cloud-agnostic, large community
   * *Cons:* Less application-aware, more verbose for AWS-specific patterns, requires HCL learning

4. **AWS CloudFormation:** Use native AWS infrastructure management.
   * *Pros:* Native AWS integration, no additional tools, integrated with AWS services
   * *Cons:* YAML/JSON verbosity, limited programming capabilities, AWS-specific

## Infrastructure Separation Strategy

### Terraform: Foundational Infrastructure
Terraform will manage long-lived, foundational resources that change infrequently:

```
terraform/
├── environments/
│   ├── dev/
│   ├── staging/
│   └── prod/
├── modules/
│   ├── networking/
│   ├── security/
│   └── storage/
└── shared/
    ├── dns/
    ├── certificates/
    └── iam/
```

**Terraform-managed resources:**
- VPC, subnets, and networking components
- Route 53 hosted zones and DNS records
- SSL/TLS certificates (ACM)
- IAM roles and policies for applications
- S3 buckets for data lake storage
- RDS instances for operational databases
- ECR repositories for container images

### AWS CDK: Application Infrastructure
CDK will manage application-specific resources that change frequently:

```
cdk/
├── stacks/
│   ├── data_pipeline_stack.py
│   ├── api_stack.py
│   ├── web_stack.py
│   └── monitoring_stack.py
├── constructs/
│   ├── containerized_service.py
│   ├── data_pipeline.py
│   └── api_gateway.py
└── environments/
    ├── dev.py
    ├── staging.py
    └── prod.py
```

**CDK-managed resources:**
- ECS services and task definitions
- Lambda functions for data processing
- API Gateway configurations
- CloudWatch monitoring and alerting
- Step Functions for workflow orchestration
- Event-driven architectures (EventBridge, SQS)

## Environment Management

### Environment Structure
```
Development Environment:
├── Terraform: hoopstat-dev-foundation
├── CDK: hoopstat-dev-apps
└── Namespace: dev

Staging Environment:
├── Terraform: hoopstat-staging-foundation
├── CDK: hoopstat-staging-apps
└── Namespace: staging

Production Environment:
├── Terraform: hoopstat-prod-foundation
├── CDK: hoopstat-prod-apps
└── Namespace: prod
```

### State Management
- **Terraform state:** Stored in S3 with DynamoDB locking
- **CDK state:** Managed by CloudFormation stacks
- **Cross-tool references:** Use SSM Parameter Store for shared values

## Deployment Pipeline

### Terraform Deployment
```yaml
# .github/workflows/terraform.yml
on:
  push:
    paths: ['terraform/**']
    
jobs:
  terraform:
    steps:
      - uses: hashicorp/setup-terraform@v2
      - run: terraform plan
      - run: terraform apply  # only on main branch
```

### CDK Deployment
```yaml
# .github/workflows/cdk.yml
on:
  push:
    paths: ['cdk/**', 'apps/**']
    
jobs:
  cdk:
    steps:
      - uses: actions/setup-node@v3
      - run: npm install -g aws-cdk
      - run: cdk diff
      - run: cdk deploy  # only on main branch
```

## Security and Best Practices

### Resource Tagging Strategy
All resources will include standardized tags:
```python
common_tags = {
    "Project": "hoopstat-haus",
    "Environment": environment,
    "Owner": "efischer19",
    "ManagedBy": "cdk",  # or "terraform"
    "CostCenter": "data-platform",
    "BackupRequired": "true"
}
```

### Security Practices
- **Least privilege IAM:** Minimal permissions for each service
- **VPC security:** Private subnets for application resources
- **Encryption:** At-rest and in-transit encryption for all data
- **Secrets management:** AWS Secrets Manager for sensitive configuration
- **Network security:** Security groups and NACLs for defense in depth

### Cost Management
- **Resource lifecycle:** Automated cleanup of temporary resources
- **Environment scaling:** Smaller instances for dev/staging
- **Monitoring:** CloudWatch billing alerts and cost allocation tags
- **Reserved instances:** For predictable production workloads

## Consequences

* **Positive:** Version-controlled infrastructure enables reproducible deployments, separation of concerns between foundational and application infrastructure, strong disaster recovery capabilities through infrastructure recreation, cost visibility through comprehensive tagging, security best practices enforced through code, automated deployment pipelines reduce manual errors.
* **Negative:** Two infrastructure tools require broader team knowledge, complex state management across tools, potential for configuration drift between environments, requires discipline in resource management and tagging.
* **Future Implications:** All infrastructure changes must go through code review process, environment provisioning becomes automated and consistent, disaster recovery procedures are tested and reliable, cost optimization is data-driven through proper tagging, security practices are enforced programmatically, infrastructure documentation is maintained through code.