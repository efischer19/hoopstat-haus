FROM python:3.12-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy library source code
COPY libs/hoopstat-mock-data /app/libs/hoopstat-mock-data
COPY libs/hoopstat-data /app/libs/hoopstat-data
COPY libs/hoopstat-e2e-testing /app/libs/hoopstat-e2e-testing

# Install dependencies directly with pip for more reliability in CI
WORKDIR /app
RUN pip install --trusted-host pypi.org --trusted-host pypi.python.org --trusted-host files.pythonhosted.org \
    boto3>=1.34.0 \
    pytest>=8.4.1 \
    docker>=7.0.0 \
    pandas>=2.0.0 \
    pyarrow>=16.0.0 \
    ruff>=0.12.3 \
    pytest-cov>=6.2.1 \
    "moto[s3]>=5.1.0" \
    requests

# Install local libraries
RUN pip install --trusted-host pypi.org --trusted-host pypi.python.org --trusted-host files.pythonhosted.org \
    -e ./libs/hoopstat-mock-data && \
    pip install --trusted-host pypi.org --trusted-host pypi.python.org --trusted-host files.pythonhosted.org \
    -e ./libs/hoopstat-data && \
    pip install --trusted-host pypi.org --trusted-host pypi.python.org --trusted-host files.pythonhosted.org \
    -e ./libs/hoopstat-e2e-testing

# Set environment variables for testing
ENV PYTHONPATH=/app
ENV AWS_ENDPOINT_URL=http://localstack:4566
ENV AWS_ACCESS_KEY_ID=test
ENV AWS_SECRET_ACCESS_KEY=test
ENV AWS_DEFAULT_REGION=us-east-1

# Default command
CMD ["python", "-m", "pytest", "testing/tests/", "-v", "--tb=short"]