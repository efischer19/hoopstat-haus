---
name: CI

"on":
  pull_request:
    branches: [main]
    paths:
      - 'apps/**'
      - 'libs/**'
      - 'meta/adr/**'
      - '.github/workflows/ci.yml'
  push:
    branches: [main]
    paths:
      - 'apps/**'
      - 'libs/**'
      - '.github/workflows/ci.yml'
  workflow_dispatch:
    inputs:
      app:
        description: 'Application to build and push to ECR'
        required: true
        type: choice
        options:
          - bronze-ingestion
          - silver-processing

permissions:
  id-token: write
  contents: read

jobs:
  check-adr-status:
    name: Check ADR Status
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for un-accepted ADRs
        run: |
          echo "ğŸ” Checking ADR status in meta/adr/ directory..."
          
          # Check if ADR directory exists
          if [ ! -d "meta/adr" ]; then
            echo "âœ… No ADR directory found, check passed"
            exit 0
          fi
          
          # Function to extract status from ADR file
          get_adr_status() {
            local file="$1"
            awk '/^---$/{flag++; next} flag==1 && /^status:/ {gsub(/^status: *"?/, ""); gsub(/"$/, ""); print; exit}' "$file"
          }
          
          # Track if any proposed ADRs are found
          found_proposed=false
          
          # Check all ADR files
          for adr_file in meta/adr/*.md; do
            if [[ -f "$adr_file" && "$(basename "$adr_file")" != "TEMPLATE.md" ]]; then
              filename=$(basename "$adr_file")
              status=$(get_adr_status "$adr_file")
              
              echo "ğŸ“„ $filename: status='$status'"
              
              if [[ "$status" == "Proposed" ]]; then
                echo "âŒ ERROR: Found ADR with 'Proposed' status: $filename"
                echo "   ADRs must be accepted before merging to main branch"
                found_proposed=true
              elif [[ "$status" == "Accepted" || "$status" == "Deprecated" || "$status" == "Superseded"* ]]; then
                echo "   âœ… Valid status"
              else
                echo "   âš ï¸  Warning: Unknown status '$status' in $filename"
              fi
            fi
          done
          
          if [[ "$found_proposed" == "true" ]]; then
            echo
            echo "âŒ CI FAILURE: Found ADRs with 'Proposed' status"
            echo "   Please use the 'Accept Proposed ADRs' workflow to accept them"
            echo "   or change their status to 'Accepted' before merging"
            exit 1
          else
            echo
            echo "âœ… All ADRs have valid status - check passed"
          fi

  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      app-matrix: ${{ steps.dispatch-defaults.outputs.app-matrix || steps.changes.outputs.app-matrix }}
      lib-matrix: ${{ steps.dispatch-defaults.outputs.lib-matrix || steps.changes.outputs.lib-matrix }}
      has-app-changes: ${{ steps.dispatch-defaults.outputs.has-app-changes || steps.changes.outputs.has-app-changes }}
      has-lib-changes: ${{ steps.dispatch-defaults.outputs.has-lib-changes || steps.changes.outputs.has-lib-changes }}
    steps:
      - name: Set defaults for workflow_dispatch
        if: github.event_name == 'workflow_dispatch'
        id: dispatch-defaults
        run: |
          echo "has-app-changes=true" >> $GITHUB_OUTPUT
          echo "app-matrix={\"include\":[{\"app\":\"${{ inputs.app }}\"}]}" >> $GITHUB_OUTPUT
          echo "has-lib-changes=false" >> $GITHUB_OUTPUT
          echo "lib-matrix={\"include\":[]}" >> $GITHUB_OUTPUT
          echo "Manual trigger for app: ${{ inputs.app }}"

      - name: Checkout code
        if: github.event_name != 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed apps and libraries
        if: github.event_name != 'workflow_dispatch'
        id: changes
        run: |
          set -eo pipefail
          echo "ğŸ” Determining changed paths for ${{ github.event_name }}..."

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          echo "BASE_SHA=$BASE_SHA"
          echo "HEAD_SHA=$HEAD_SHA"

          if [ -z "$BASE_SHA" ] || echo "$BASE_SHA" | grep -q '^0\{40\}$'; then
            echo "âš ï¸  No valid BASE_SHA; using previous commit as base"
            BASE_SHA=$(git rev-parse HEAD~1 || true)
          fi

          if [ -z "$BASE_SHA" ]; then
            echo "âš ï¸  Treating as initial commit; listing files under apps/ and libs/"
            changed_app_files=$(git ls-files 'apps/*' | cut -d'/' -f2 | sort -u)
            changed_lib_files=$(git ls-files 'libs/*' | cut -d'/' -f2 | sort -u)
          else
            echo "ğŸ” Diffing changes between $BASE_SHA..$HEAD_SHA"
            changed_app_files=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep '^apps/' || true)
            changed_app_files=$(echo "$changed_app_files" | cut -d'/' -f2 | sort -u)
            changed_lib_files=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep '^libs/' || true)
            changed_lib_files=$(echo "$changed_lib_files" | cut -d'/' -f2 | sort -u)

            # Check for apps that depend on changed libraries
            if [ -n "$changed_lib_files" ]; then
              echo "Checking for apps dependent on changed libraries..."
              for lib in $changed_lib_files; do
                echo "  Checking dependents of $lib..."
                for app_toml in apps/*/pyproject.toml; do
                  if [ -f "$app_toml" ]; then
                    # Check if the library is mentioned in the pyproject.toml
                    # This covers path dependencies like {path = "../../libs/libname"}
                    if grep -q "$lib" "$app_toml"; then
                      app_name=$(basename $(dirname "$app_toml"))
                      echo "    App $app_name depends on $lib - marking for build"
                      changed_app_files="$(printf "%s\n%s" "$changed_app_files" "$app_name")"
                    fi
                  fi
                done
              done
              # Deduplicate
              changed_app_files=$(echo "$changed_app_files" | sort -u | grep -v '^$')
            fi
          fi

          # Process apps
          if [ -z "$changed_app_files" ]; then
            echo "has-app-changes=false" >> $GITHUB_OUTPUT
            echo "app-matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            echo "No changes detected in apps directory"
          else
            echo "has-app-changes=true" >> $GITHUB_OUTPUT

            # Build matrix of changed apps
            app_matrix_items=""
            for app in $changed_app_files; do
              if [ -f "apps/$app/pyproject.toml" ]; then
                if [ -n "$app_matrix_items" ]; then
                  app_matrix_items="$app_matrix_items,"
                fi
                app_matrix_items="$app_matrix_items{\"app\":\"$app\"}"
              fi
            done

            if [ -n "$app_matrix_items" ]; then
              echo "app-matrix={\"include\":[$app_matrix_items]}" >> $GITHUB_OUTPUT
              echo "Found Python apps with changes: $changed_app_files"
            else
              echo "has-app-changes=false" >> $GITHUB_OUTPUT
              echo "app-matrix={\"include\":[]}" >> $GITHUB_OUTPUT
              echo "No Python apps with pyproject.toml found in changed dirs"
            fi
          fi

          # Process libraries
          if [ -z "$changed_lib_files" ]; then
            echo "has-lib-changes=false" >> $GITHUB_OUTPUT
            echo "lib-matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            echo "No changes detected in libs directory"
          else
            echo "has-lib-changes=true" >> $GITHUB_OUTPUT

            # Build matrix of changed libraries
            lib_matrix_items=""
            for lib in $changed_lib_files; do
              if [ -f "libs/$lib/pyproject.toml" ]; then
                if [ -n "$lib_matrix_items" ]; then
                  lib_matrix_items="$lib_matrix_items,"
                fi
                lib_matrix_items="$lib_matrix_items{\"lib\":\"$lib\"}"
              fi
            done

            if [ -n "$lib_matrix_items" ]; then
              echo "lib-matrix={\"include\":[$lib_matrix_items]}" >> $GITHUB_OUTPUT
              echo "Found Python libraries with changes: $changed_lib_files"
            else
              echo "has-lib-changes=false" >> $GITHUB_OUTPUT
              echo "lib-matrix={\"include\":[]}" >> $GITHUB_OUTPUT
              echo "No Python libraries with pyproject.toml found in changed dirs"
            fi
          fi

  test-libraries:
    name: Test Libraries
    needs: detect-changes
    if: needs.detect-changes.outputs.has-lib-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.lib-matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python and Poetry
        uses: ./.github/actions/setup-python-poetry
        with:
          working-directory: libs/${{ matrix.lib }}

      - name: Install dependencies
        working-directory: libs/${{ matrix.lib }}
        run: poetry install

      - name: Format check
        working-directory: libs/${{ matrix.lib }}
        run: poetry run ruff format --check .

      - name: Lint
        working-directory: libs/${{ matrix.lib }}
        run: poetry run ruff check .

      - name: Test
        working-directory: libs/${{ matrix.lib }}
        run: poetry run pytest

      - name: Library validation
        working-directory: libs/${{ matrix.lib }}
        run: |
          echo "âœ… Library ${{ matrix.lib }} passed all tests"
          echo "ğŸ“¦ Library is ready for use by applications"

  test-applications:
    name: Test Applications
    needs: detect-changes
    if: needs.detect-changes.outputs.has-app-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.app-matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python and Poetry
        uses: ./.github/actions/setup-python-poetry
        with:
          working-directory: apps/${{ matrix.app }}

      - name: Install dependencies
        working-directory: apps/${{ matrix.app }}
        run: poetry install

      - name: Format check
        working-directory: apps/${{ matrix.app }}
        run: poetry run ruff format --check .

      - name: Lint
        working-directory: apps/${{ matrix.app }}
        run: poetry run ruff check .

      - name: Test
        working-directory: apps/${{ matrix.app }}
        run: poetry run pytest

  build-push-images:
    name: Build and Push Images
    needs: [detect-changes, test-applications]
    if: needs.detect-changes.outputs.has-app-changes == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.app-matrix) }}
    uses: ./.github/workflows/reusable-build-push.yml
    with:
      app_name: ${{ matrix.app }}
      push: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
      tags: ${{ github.sha }},latest
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

  test-integration:
    name: Test App-Library Integration
    needs: [detect-changes, test-libraries]
    if: needs.detect-changes.outputs.has-app-changes == 'true' && needs.detect-changes.outputs.has-lib-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.app-matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python and Poetry
        uses: ./.github/actions/setup-python-poetry
        with:
          working-directory: apps/${{ matrix.app }}

      - name: Test app with updated libraries
        working-directory: apps/${{ matrix.app }}
        run: |
          echo "ğŸ”— Testing integration between ${{ matrix.app }} and changed libraries"
          
          # Install app dependencies (including any local library dependencies)
          poetry install
          
          # Run tests to validate integration
          poetry run pytest
          
          echo "âœ… Integration testing passed for ${{ matrix.app }}"
          echo "ğŸ”— Application works correctly with updated shared libraries"

  test-e2e-pipeline:
    name: Test E2E Pipeline
    needs: [detect-changes, test-libraries]
    if: >
      github.event_name == 'push' ||
      contains(needs.detect-changes.outputs.lib-matrix, 'hoopstat-e2e-testing') ||
      contains(needs.detect-changes.outputs.lib-matrix, 'hoopstat-mock-data') ||
      contains(needs.detect-changes.outputs.lib-matrix, 'hoopstat-data') ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.body, '[e2e]'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python and Poetry
        uses: ./.github/actions/setup-python-poetry
        with:
          working-directory: libs/hoopstat-e2e-testing

      - name: Install E2E testing dependencies
        working-directory: libs/hoopstat-e2e-testing
        run: poetry install

      - name: Run E2E Pipeline Tests (Unit Mode)
        working-directory: libs/hoopstat-e2e-testing
        run: |
          echo "ğŸš€ Running E2E pipeline tests with moto simulation"
          poetry run pytest tests/ -v --tb=short
          echo "âœ… E2E pipeline tests passed"

      - name: E2E Testing Summary
        run: |
          echo "ğŸ“‹ E2E Testing Summary:"
          echo "   âœ… Unit tests with moto S3 simulation: PASSED"
          echo "   ğŸ“¦ Framework ready for local Docker testing"
          echo ""
          echo "ğŸ³ For full integration testing with Localstack (local development):"
          echo "   docker compose -f docker-compose.test.yml up --build"
